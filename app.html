<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>

  <!-- Google tag (gtag.js)  -->
  <!-- TODO: 業務かるがも用の GA4 ID に差し替え -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script>
  <script>
    const isDebug = new URLSearchParams(location.search).get('debug') === '1';
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-XXXXXXXXXX', {
      debug_mode: isDebug,
      linker: { domains: ['gyomu-karugamo.com', 'app.gyomu-karugamo.com'] }
    });
  </script>

  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>業務かるがも | アプリ</title>

  <style>
    :root{
      /* ===== Base (背景はベージュで固定) ===== */
      --bg:#faf8f4;
      --panel:#ffffff;
      --ink:#2a241a;
      --muted:#6f6a60;

      /* ===== Brand (ロゴの茶〜オレンジ寄り) ===== */
      --brand:#c86b12;        /* 橙寄りの主役 */
      --brand-deep:#7a3f07;   /* 濃い茶 */
      --brand-soft:#fff1dd;   /* 薄いクリーム */
      --brand-line:#f0d2ad;   /* 境界線 */
      --brand-link:#7a3f07;   /* ★追加：リンク色（未定義だったため） */

      --tab-active-bg:#e6d6cf;
      --tab-active-ink:#7a3f07;
    
      --plan-bg:#e6d6cf;
      --plan-border:#f1d7b6;

      /* ===== UI ===== */
      --radius:20px;

      /* 影（薄め・上品） */
      --shadow-soft: 0 12px 30px rgba(43, 36, 27, .10);
      --shadow-mini: 0 10px 22px rgba(43, 36, 27, .10);

      /* 境界線（薄い茶系） */
      --edge: rgba(90, 58, 34, .10);
    }
    *{box-sizing:border-box;}
    html,body{ margin:0; height:100%; }
    body{
      min-height:100vh;
      background:var(--bg);
      color:var(--ink);
      font-family:system-ui,-apple-system,"Segoe UI",Roboto;
    }
    .page{ max-width:1120px; margin:0 auto; padding:0 18px 32px; }

    /* ヘッダー */
    .site-header{
      position:fixed;
      top:0; left:0; right:0;
      z-index:100;
      background:rgba(250,248,244,1);
      backdrop-filter:none;
      border-bottom:none;
    }

    .header-wrap{
      padding:14px 0 10px;
      position:relative;
    }

    /* ★追加：タブと本文の境目を自然にする“フェード＋ぼかし” */
    .header-wrap::after{
      content:"";
      position:absolute;
      left:0; right:0;
      bottom:-26px;              /* 少し深めに */
      height:54px;               /* フェードの厚み */
      pointer-events:none;
      z-index:0;
      background: linear-gradient(
        to bottom,
        rgba(250,248,244,0) 0%,
        rgba(250,248,244,.45) 30%,
        rgba(250,248,244,.85) 62%,
        rgba(250,248,244,1) 100%
      );
      filter: blur(3px);
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      margin-bottom:14px;
    }
    .brand{ display:flex; align-items:center; gap:14px; }
    .brand img{
      max-width:120px;
      height:auto;
      display:block;
      filter:none;
    }
    .brand-title span{
      font-size:18px;
      letter-spacing:.10em;
      color:var(--muted);
      font-weight:700;
      white-space:nowrap;
    }

    .user-box{
      display:flex;
      align-items:center;
      gap:10px;
      font-size:13px;
      color:var(--muted);
      justify-content:flex-end;
      flex-wrap:wrap;
    }
    .pill{
      border-radius:999px;
      background:#ffffff;
      padding:4px 10px;
      border:1px solid rgba(0,0,0,.10);
    }
    .btn{
      border-radius:999px;
      border:1px solid rgba(0,0,0,.14);
      background:#fff;
      padding:7px 12px;
      cursor:pointer;
      font-size:13px;
      color:var(--ink);
      user-select:none;
    }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }

    .btn-primary{
      background:var(--brand);
      border-color:transparent;
      color:#fff;
      font-weight:800;
    }
    .btn-outline{ background:#fff; color:var(--ink); }

    .btn-danger{
      background:#ffe7e3;
      border-color:#ffb3a7;
      color:#8b1a07;
      font-weight:800;
    }
    .input{
      border-radius:999px;
      border:1px solid rgba(0,0,0,.14);
      background:#fff;
      padding:7px 10px;
      font-size:13px;
      min-width:220px;
    }

    /* ★修正：タブに影＆境界線を付けて背景と分離 */
    .tabs{
      position:relative;
      z-index:1;

      display:flex;
      gap:4px;
      overflow:auto;
      padding:4px;

      border-radius:999px;
      background: rgba(255,255,255,.92);
      border: 1px solid var(--edge);
      box-shadow: var(--shadow-mini);
    }
    .tab-btn{
      flex:1;
      min-width:0;
      border:none;
      background:transparent;
      border-radius:999px;
      padding:10px 12px;
      font-size:14px;
      cursor:pointer;
      letter-spacing:.12em;
      color:var(--ink);
    }
    
    .tab-btn.active{
      background:var(--tab-active-bg);
      color:var(--tab-active-ink);
      outline:none;
      font-weight:900;
    }

    /* ★修正：タブ下と本文の間に“間隔”を作る（見た目の詰まり解消） */
    .main-page{ padding-top:190px; }
    main{ margin-top:46px; }

    /* ★修正：カードも影を付けて背景と分離（既に影あったが整理して強化） */
    .card{
      background:var(--panel);
      border-radius:var(--radius);
      padding:20px 20px 24px;
      margin-bottom:24px;

      border:1px solid var(--edge);
      box-shadow: var(--shadow-soft);
    }
    .tab-pane{display:none;}
    .tab-pane.active{display:block;}

    h2{ margin:0 0 10px; font-size:20px; }
    h3{ margin:14px 0 6px; font-size:16px; }
    p{ margin:6px 0; line-height:1.7; font-size:14px; }
    .muted{color:var(--muted);}

    .status-box{
      background:var(--plan-bg);
  　  border:1px solid var(--plan-border);

      border-radius:16px;
      padding:12px 14px;
      font-size:13px;
      margin-top:8px;
    }
    .cta-row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:10px;
      align-items:center;
    }
    .hidden{display:none;}

    a{ color:var(--brand-link); text-decoration:none; }
    a:hover{ text-decoration:underline; }

    .pw-banner{
      background:#ffe7e3;
      border:1px solid #ffb3a7;
      color:#8b1a07;
      border-radius:12px;
      padding:10px 14px;
      margin-bottom:14px;
      font-size:14px;
      font-weight:800;
      cursor:pointer;
    }

    footer{
      margin-top:18px;
      text-align:center;
      font-size:12px;
      color:var(--muted);
    }

    @media (max-width: 768px){
      .topbar{ flex-direction:column; align-items:flex-start; gap:8px; }
      .brand img{ max-width:180px; }
      .brand-title span{ font-size:16px; letter-spacing:.08em; white-space:normal; line-height:1.2; }
      .user-box{ justify-content:flex-start; }

      .tabs{
        border-radius:16px;
        padding:4px 6px;
        gap:6px;
        -webkit-overflow-scrolling:touch;
      }
      .tab-btn{
        flex:0 0 auto;
        white-space:nowrap;
        font-size:12px;
        letter-spacing:.08em;
        padding:8px 10px;
      }

      /* ★SPはヘッダーが高いので余白を少し増やす */
      .main-page{ padding-top:230px; }
      main{ margin-top:40px; }
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
  <header class="site-header">
    <div class="page header-wrap">
      <div class="topbar">
        <div class="brand">
          <img src="/assets/logo-gyomu-karugamo.png" alt="業務かるがも" />
          <div class="brand-title">
            <span>業務自動化ツール</span>
          </div>
        </div>

        <div class="user-box">
          <span>ログイン中：</span>
          <span id="userEmail" class="pill">-</span>
          <button id="logout" class="btn btn-outline">ログアウト</button>
        </div>
      </div>

      <nav class="tabs">
        <button class="tab-btn active" data-tab="home">HOME</button>
        <button class="tab-btn" data-tab="tools">TOOLS</button>
        <button class="tab-btn" data-tab="account">ACCOUNT</button>
      </nav>
    </div>
  </header>

  <div class="page main-page">
    <main>
      <!-- 未ログイン時 -->
      <div id="notLoggedAlert" class="card hidden" style="background:#fff7e0;border:1px solid #f3d38a;">
        <p class="muted" style="font-size:14px;margin-bottom:8px;">
          未ログインか、ブラウザが変わったためログイン情報を確認できませんでした。もう一度ログインしてください。
        </p>
        <a href="./" style="font-size:14px;">ログイン画面に戻る</a>
      </div>

      <!-- HOME -->
      <section id="tab-home" class="tab-pane active">
        <div class="card">
          <div id="pwBanner" class="pw-banner hidden">
            パスワードが未設定です。こちらをクリックして設定してください。
          </div>

          <h2>ようこそ、業務かるがもへ</h2>
          <p class="muted">
            このサイトでは、配布された自動化ツールを実行できます。<br>
            まずは ACCOUNT でプラン状態を確認し、TOOLS からツールを選択する流れになります。
          </p>

          <div class="status-box">
            <div>
              現在のプラン：<strong id="planLabelText">Free</strong>
            </div>
            <p id="statusText" class="muted" style="margin-top:6px;">ログイン状態を確認しています…</p>
          </div>
        </div>
      </section>

      <!-- TOOLS -->
      <section id="tab-tools" class="tab-pane">
        <div class="card">
          <h2>ツール一覧</h2>

          <p id="toolsGateText" class="muted">
            Standardプランに登録すると、すべてのツールが利用できます。
          </p>
          <button id="btnSubscribeTools" class="btn btn-primary hidden" style="margin-top:10px;">
            Standardプランに登録する
          </button>

          <hr style="margin:18px 0;border:none;border-top:1px solid rgba(0,0,0,.08);" />

          <p class="muted">現在、表示できるツールがありません。</p>
          <div id="tools" class="hidden"></div>
        </div>
      </section>

      <!-- ACCOUNT -->
      <section id="tab-account" class="tab-pane">
        <div class="card">
          <h2>アカウント・プラン情報</h2>
          <p class="muted">現在のプラン確認、Standardプラン登録、解約ができます。</p>

          <div class="status-box">
            <div>
              現在のプラン：<strong id="planLabelText2">Free</strong>
            </div>
            <p id="statusText2" class="muted" style="margin-top:6px;">ログイン状態を確認しています…</p>
          </div>

          <div class="cta-row">
            <button id="btnSubscribe" class="btn btn-primary hidden">Standardプランに登録する</button>
            <button id="btnCancel" class="btn btn-danger hidden">サブスクを解約する</button>
          </div>

          <hr style="margin:18px 0;border:none;border-top:1px solid rgba(0,0,0,.08);" />

          <h3>メールアドレスの変更</h3>
          <p class="muted" style="font-size:13px;">
            新しいメールアドレスを入力すると確認メールを送信します。メール内のリンクから変更を完了してください。
          </p>

          <p style="font-size:13px;margin-top:8px;">
            現在のメールアドレス：<strong id="currentEmailText"></strong>
          </p>

          <div style="margin-top:8px;display:flex;flex-wrap:wrap;gap:8px;align-items:center;">
            <input id="emailNew" type="email" class="input" placeholder="new-address@example.com" />
            <button id="btnChangeEmail" class="btn btn-outline">変更用メールを送信</button>
          </div>
          <p id="emailChangeMsg" class="muted" style="font-size:12px;margin-top:6px;"></p>

          <hr style="margin:18px 0;border:none;border-top:1px solid rgba(0,0,0,.08);" />

          <div id="pwSection" class="hidden">
            <h3>パスワードの設定</h3>
            <p class="muted" style="font-size:13px;">
              初回登録がメール認証のみの場合、ここでパスワードを設定すると次回から「メール＋パスワード」でログインできます。
            </p>
            <small class="muted">8文字以上で、他サービスと使い回さないパスワード推奨。</small>

            <form id="pwForm" novalidate style="margin-top:10px;display:flex;flex-direction:column;gap:8px;max-width:320px;">
              <input id="pwNew"  type="password" class="input" placeholder="新しいパスワード（8文字以上）" />
              <input id="pwNew2" type="password" class="input" placeholder="確認のため、同じパスワードをもう一度" />
              <div style="display:flex;align-items:center;gap:6px;margin-top:4px;">
                <input type="checkbox" id="pwShowSetup" />
                <label for="pwShowSetup" style="font-size:13px;">パスワードを表示する</label>
              </div>
              <button id="pwSubmit" type="submit" class="btn btn-outline">パスワードを設定する</button>
            </form>

            <p id="pwMsg" class="muted" style="font-size:12px;margin-top:6px;"></p>
          </div>

          <div id="pwChangeSection" class="hidden" style="margin-top:18px;">
            <h3>パスワードの変更</h3>
            <p class="muted" style="font-size:13px;">現在ログイン中のアカウントのパスワードを変更できます（古いパスワードは不要）。</p>
            <small class="muted">8文字以上推奨。</small>

            <form id="pwChangeForm" novalidate style="margin-top:10px;display:flex;flex-direction:column;gap:8px;max-width:320px;">
              <input id="pwChangeNew"  type="password" class="input" placeholder="新しいパスワード（8文字以上）" />
              <input id="pwChangeNew2" type="password" class="input" placeholder="確認のため、同じパスワードをもう一度" />
              <div style="display:flex;align-items:center;gap:6px;margin-top:4px;">
                <input type="checkbox" id="pwShowChange" />
                <label for="pwShowChange" style="font-size:13px;">パスワードを表示する</label>
              </div>
              <button id="pwChangeSubmit" type="submit" class="btn btn-outline">パスワードを変更する</button>
            </form>

            <p id="pwChangeMsg" class="muted" style="font-size:12px;margin-top:6px;"></p>
          </div>
        </div>
      </section>
    </main>

    <footer>
      <div id="legalLinks" style="margin-top:4px;font-size:11px;">
        <a href="/terms.html" target="_blank" rel="noopener">利用規約</a> /
        <a href="/privacy.html" target="_blank" rel="noopener">プライバシーポリシー</a>
      </div>
    </footer>
  </div>

<script>
  // =========================
  // Supabase 設定（差し替え）
  // =========================
  const SUPABASE_URL = "https://rhynpigqhnbwjyudvvfw.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJoeW5waWdxaG5id2p5dWR2dmZ3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3ODcyNTMsImV4cCI6MjA4MzM2MzI1M30.S9h-SH0JB0cEhMukUUaOuYEetx2I8qecZapIeCpk57M";

  const SITE_TOP_URL = "https://app.gyomu-karugamo.com/app.html";

  const sb = window.supabase.createClient(
    SUPABASE_URL,
    SUPABASE_ANON_KEY,
    {
      auth: {
        persistSession: true,
        autoRefreshToken: true,
        detectSessionInUrl: true,
      },
    }
  );

  const BILLING_JSON_URL = "https://app.gyomu-karugamo.com/data/billing.json";
  let BILLING_CONFIG = { stripe: { standard: { payment_link_url: null } } };

  const PORTAL_FUNCTION_URL = "https://rhynpigqhnbwjyudvvfw.functions.supabase.co/create-portal-session";

  const $ = (s)=>document.querySelector(s);

  function switchToTab(tab){
    document.querySelectorAll(".tab-btn").forEach(btn=>{
      btn.classList.toggle("active", btn.dataset.tab === tab);
    });
    document.querySelectorAll(".tab-pane").forEach(p=>{
      p.classList.toggle("active", p.id === "tab-"+tab);
    });
  }
  document.querySelectorAll(".tab-btn").forEach(btn=>{
    btn.addEventListener("click", ()=>switchToTab(btn.dataset.tab));
  });

  const sleep = ms => new Promise(r=>setTimeout(r,ms));

  function urlHasAuthCode(){
    const u = new URL(location.href);
    return u.searchParams.has("code") || u.searchParams.has("token") || u.hash.includes("access_token");
  }

  async function getUserRobust({tries=40, interval=150}={}){
    try{
      const { data } = await sb.auth.getSession();
      const s = data?.session;
      if (s?.user) return s.user;
    }catch(e){}

    if (urlHasAuthCode()){
      try{
        await sb.auth.exchangeCodeForSession(window.location.href);
      }catch(e){}
    }

    for(let i=0;i<tries;i++){
      try{
        const { data:{ user } } = await sb.auth.getUser();
        if (user) return user;
      }catch(e){}
      await sleep(interval);
    }
    return null;
  }

  async function loadProfileOrCreate(userId){
    let { data:prof, error } = await sb
      .from("profiles")
      .select("id,tier,is_active,has_password,display_name")
      .eq("id", userId)
      .single();

    const notFound = error && (error.code==="PGRST116" || String(error.details||"").includes("0 rows"));
    if (notFound){
      const up = await sb.from("profiles").upsert(
        { id:userId, tier:"free", is_active:false, has_password:false },
        { onConflict:"id" }
      );
      if (up.error) return { data:null, error:up.error };

      ({ data:prof, error } = await sb
        .from("profiles")
        .select("id,tier,is_active,has_password,display_name")
        .eq("id", userId)
        .single());
    }
    return { data:prof, error };
  }

  function planLabel(tier, isActive){
    if (!isActive) return "Free";
    const t = String(tier||"free").toLowerCase();
    if (t === "standard") return "Standard";
    if (t === "pro") return "Pro";
    return "Free";
  }

  function setStatus(text){
    const el = $("#statusText");
    if (el) el.textContent = text;
    const el2 = $("#statusText2");
    if (el2) el2.textContent = text;
  }

  function setPlanLabelText(v){
    const a = $("#planLabelText");
    const b = $("#planLabelText2");
    if (a) a.textContent = v;
    if (b) b.textContent = v;
  }

  async function loadBillingConfig(){
    try{
      const res = await fetch(BILLING_JSON_URL, { cache:"no-store" });
      if(!res.ok) throw new Error("HTTP " + res.status);
      const data = await res.json();
      BILLING_CONFIG = data || BILLING_CONFIG;
    }catch(e){
      console.error("billing json load error", e);
      BILLING_CONFIG = { stripe: { standard: { payment_link_url: null } } };
    }
  }

  async function createCheckout(userId, userEmail){
    const baseUrl = BILLING_CONFIG?.stripe?.standard?.payment_link_url;
    if (!baseUrl){
      alert("課金設定の読み込みに失敗しました（billing.json の payment_link_url を確認してください）");
      return;
    }

    const params = new URLSearchParams();
    if (userEmail) params.set("prefilled_email", String(userEmail));
    if (userId) params.set("client_reference_id", String(userId));

    const sep = baseUrl.includes("?") ? "&" : "?";
    const url = params.toString() ? (baseUrl + sep + params.toString()) : baseUrl;

    try{ gtag('event', 'begin_checkout', { plan:'standard', method:'stripe_payment_link' }); }catch(e){}
    location.href = url;
  }

  async function openPortal(userId){
    try{
      const { data:sess } = await sb.auth.getSession();
      const token = sess?.session?.access_token;
      if (!token){
        alert("セッションが取得できませんでした。再ログイン後にお試しください。");
        return;
      }

      const res = await fetch(PORTAL_FUNCTION_URL, {
        method:"POST",
        headers:{
          "Content-Type":"application/json",
          "Authorization":`Bearer ${token}`
        },
        body:JSON.stringify({
          user_id:userId,
          return_url:SITE_TOP_URL
        })
      });

      if (!res.ok){
        const bodyText = await res.text().catch(()=> "");
        console.error("openPortal failed:", res.status, bodyText);
        alert("サブスクリプション管理ページを開けませんでした。時間をおいて再度お試しください。");
        return;
      }

      const data = await res.json();
      if (!data?.url){
        console.error("openPortal: url missing", data);
        alert("サブスクリプション管理ページを開けませんでした。時間をおいて再度お試しください。");
        return;
      }
      location.href = data.url;
    }catch(e){
      console.error("openPortal error", e);
      alert("サブスクリプション管理ページを開けませんでした。時間をおいて再度お試しください。");
    }
  }

  async function handleChangeEmail(currentUser){
    const msgEl = $("#emailChangeMsg");
    const btn = $("#btnChangeEmail");
    const input = $("#emailNew");
    if (!msgEl || !btn || !input) return;

    msgEl.style.color = "#6f6a60";
    msgEl.textContent = "";

    const newEmail = input.value.trim();
    const currentEmail = currentUser?.email || "";

    const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailPattern.test(newEmail)){
      msgEl.style.color = "#b00020";
      msgEl.textContent = "正しいメールアドレスを入力してください。";
      return;
    }
    if (newEmail.toLowerCase() === currentEmail.toLowerCase()){
      msgEl.style.color = "#b00020";
      msgEl.textContent = "現在のメールアドレスと同じです。別のメールアドレスを入力してください。";
      return;
    }

    btn.disabled = true;
    try{
      const { error } = await sb.auth.updateUser(
        { email: newEmail },
        { emailRedirectTo: SITE_TOP_URL }
      );
      if (error){
        console.error(error);
        msgEl.style.color = "#b00020";
        msgEl.textContent = "メールアドレスの変更中にエラーが発生しました。時間をおいて再度お試しください。";
        return;
      }
      msgEl.textContent = "新しいメールアドレス宛に確認メールを送信しました。メール内のリンクから変更を完了してください。";
      input.value = "";
    }finally{
      btn.disabled = false;
    }
  }

  function bindPasswordToggle(checkboxId, inputIds){
    const cb = document.getElementById(checkboxId);
    if (!cb) return;
    cb.addEventListener("change", ()=>{
      const type = cb.checked ? "text" : "password";
      inputIds.forEach(id=>{
        const el = document.getElementById(id);
        if (el) el.type = type;
      });
    });
  }

  async function setPasswordFlow(userId, isChange){
    const msgEl = document.getElementById(isChange ? "pwChangeMsg" : "pwMsg");
    const btnId = isChange ? "pwChangeSubmit" : "pwSubmit";
    const p1id = isChange ? "pwChangeNew" : "pwNew";
    const p2id = isChange ? "pwChangeNew2" : "pwNew2";

    const btn = document.getElementById(btnId);
    const p1 = (document.getElementById(p1id)?.value || "").trim();
    const p2 = (document.getElementById(p2id)?.value || "").trim();

    if (msgEl){ msgEl.style.color = "#6f6a60"; msgEl.textContent = ""; }

    if (!p1){ if (msgEl){ msgEl.style.color="#b00020"; msgEl.textContent="パスワードを入力してください。"; } return; }
    if (!p2){ if (msgEl){ msgEl.style.color="#b00020"; msgEl.textContent="確認用パスワードを入力してください。"; } return; }
    if (p1.length < 8){ if (msgEl){ msgEl.style.color="#b00020"; msgEl.textContent="パスワードは8文字以上にしてください。"; } return; }
    if (p1 !== p2){ if (msgEl){ msgEl.style.color="#b00020"; msgEl.textContent="パスワードが一致しません。"; } return; }

    if (btn) btn.disabled = true;
    try{
      const { error:updateErr } = await sb.auth.updateUser({ password:p1 });
      if (updateErr){
        console.error(updateErr);
        if (msgEl){ msgEl.style.color="#b00020"; msgEl.textContent="パスワード設定中にエラーが発生しました。時間をおいて再度お試しください。"; }
        return;
      }

      try{ await sb.from("profiles").update({ has_password:true }).eq("id", userId); }catch(e){}

      const sec = document.getElementById("pwSection");
      const sec2 = document.getElementById("pwChangeSection");
      if (sec && !isChange) sec.classList.add("hidden");
      if (sec2 && !isChange) sec2.classList.remove("hidden");

      const banner = document.getElementById("pwBanner");
      if (banner) banner.classList.add("hidden");

      if (msgEl){
        msgEl.style.color="#6f6a60";
        msgEl.textContent = isChange
          ? "パスワードを変更しました。次回からは新しいパスワードでログインしてください。"
          : "パスワードを設定しました。次回からはログイン画面でメールアドレスとパスワードをご利用ください。";
      }

      const a = document.getElementById(p1id);
      const b = document.getElementById(p2id);
      if (a) a.value = "";
      if (b) b.value = "";
    }finally{
      if (btn) btn.disabled = false;
    }
  }

  function setupPwBanner(hasPassword){
    const banner = document.getElementById("pwBanner");
    if (!banner) return;

    if (hasPassword){
      banner.classList.add("hidden");
      banner.onclick = null;
      return;
    }

    banner.classList.remove("hidden");
    banner.onclick = ()=>{
      switchToTab("account");
      const target = document.getElementById("pwSection");
      if (target) target.scrollIntoView({ behavior:"smooth", block:"center" });
    };
  }

  async function main(){
    await loadBillingConfig();

    const user = await getUserRobust();
    if (!user){
      $("#userEmail").textContent = "-";
      const alertBox = $("#notLoggedAlert");
      if (alertBox) alertBox.classList.remove("hidden");
      setStatus("未ログインです。");
      setPlanLabelText("Free");
      return;
    }

    $("#userEmail").textContent = user.email || "";
    $("#currentEmailText").textContent = user.email || "";

    try{
      const k = "ga_login_success_sent";
      if (!sessionStorage.getItem(k)){
        gtag('event', 'login_success', { method:'session_restored', funnel_step:'login_complete' });
        sessionStorage.setItem(k, "1");
      }
    }catch(e){}

    const profRes = await loadProfileOrCreate(user.id);
    if (profRes.error || !profRes.data){
      console.error("profile load error", profRes.error);
      setStatus("アカウント情報の取得に失敗しました。");
      setPlanLabelText("Free");
      return;
    }

    const prof = profRes.data;
    const tier = String(prof.tier||"free").toLowerCase();
    const isActive = !!prof.is_active;

    const planText = planLabel(tier, isActive);
    setPlanLabelText(planText);
    setStatus(isActive ? "準備ができました。" : "Freeプランです。");

    const hasPassword = !!prof.has_password;
    const pwSec = document.getElementById("pwSection");
    const pwChg = document.getElementById("pwChangeSection");
    if (pwSec) pwSec.classList.toggle("hidden", hasPassword);
    if (pwChg) pwChg.classList.toggle("hidden", !hasPassword);
    setupPwBanner(hasPassword);

    bindPasswordToggle("pwShowSetup", ["pwNew","pwNew2"]);
    bindPasswordToggle("pwShowChange", ["pwChangeNew","pwChangeNew2"]);

    const btnChangeEmail = $("#btnChangeEmail");
    if (btnChangeEmail) btnChangeEmail.onclick = ()=>handleChangeEmail(user);

    const pwForm = document.getElementById("pwForm");
    if (pwForm) pwForm.onsubmit = (e)=>{ e.preventDefault(); setPasswordFlow(user.id, false); };

    const pwChangeForm = document.getElementById("pwChangeForm");
    if (pwChangeForm) pwChangeForm.onsubmit = (e)=>{ e.preventDefault(); setPasswordFlow(user.id, true); };

    const btnSubMain  = document.getElementById("btnSubscribe");
    const btnSubTools = document.getElementById("btnSubscribeTools");
    const btnCancel   = document.getElementById("btnCancel");

    if (!isActive || tier === "free"){
      const gate = document.getElementById("toolsGateText");
      if (gate) gate.textContent = "Standardプランに登録すると、すべてのツールが利用できます。";

      [btnSubMain, btnSubTools].forEach(b=>{
        if (!b) return;
        b.classList.remove("hidden");
        b.onclick = ()=>createCheckout(user.id, user.email || "");
      });

      if (btnCancel){
        btnCancel.classList.add("hidden");
        btnCancel.onclick = null;
      }
    }else{
      const gate = document.getElementById("toolsGateText");
      if (gate) gate.textContent = "利用可能なツールを表示します（準備中）。";

      [btnSubMain, btnSubTools].forEach(b=>{
        if (!b) return;
        b.classList.add("hidden");
        b.onclick = null;
      });

      if (btnCancel){
        btnCancel.classList.remove("hidden");
        btnCancel.onclick = ()=>openPortal(user.id);
      }
    }

    const logoutBtn = $("#logout");
    if (logoutBtn){
      logoutBtn.onclick = async ()=>{
        try{ await sb.auth.signOut(); }catch(e){}
        location.replace("./");
      };
    }
  }

  main();
</script>

</body>
</html>
